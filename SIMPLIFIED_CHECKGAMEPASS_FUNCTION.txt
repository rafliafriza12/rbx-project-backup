// SIMPLIFIED checkGamepassExists function
// Only uses the NEW stable User-based GamePass API

const checkGamepassExists = async () => {
  if (!selectedPlace || robux <= 0) return;

  setIsCheckingGamepass(true);
  setGamepassCheckResult(null);

  try {
    const expectedRobux = getGamepassAmount();
    
    // Get userId from userInfo
    const userId = userInfo?.id;
    
    if (!userId) {
      toast.error("User ID tidak ditemukan. Mohon cari username Roblox terlebih dahulu.");
      setIsCheckingGamepass(false);
      return;
    }

    console.log(`ðŸ” Checking gamepass for User ID: ${userId}, expected price: ${expectedRobux} Robux`);

    // Use NEW stable API endpoint (User-based GamePass API)
    // This endpoint is reliable and returns all gamepasses owned by the user
    const response = await fetch(
      `/api/check-gamepass?userId=${userId}&expectedRobux=${expectedRobux}`
    );

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();

    // Log result
    if (data.success) {
      console.log(`âœ… GamePass found! Name: ${data.gamepass?.name}, Price: ${data.gamepass?.price} Robux`);
    } else {
      console.log(`âŒ GamePass not found. Total gamepasses: ${data.allGamepasses?.length || 0}`);
    }

    setGamepassCheckResult(data);

    if (data.success) {
      // GamePass found, mark instruction as shown
      setGamepassInstructionShown(true);
      setShowGamepassModal(false);
      setLastCheckedRobuxAmount(robux); // Save the robux amount that was successfully checked

      // Show success message
      toast.success(
        `GamePass berhasil ditemukan! Nama: ${data.gamepass?.name}, Harga: ${data.gamepass?.price} Robux`,
        {
          position: "top-right",
          autoClose: 5000,
          hideProgressBar: false,
          closeOnClick: true,
          pauseOnHover: true,
          draggable: true,
        }
      );
    } else {
      // GamePass not found, show error with existing gamepasses
      let errorMessage = `${data.message}`;
      if (data.allGamepasses && data.allGamepasses.length > 0) {
        errorMessage += `. Pastikan GamePass dengan harga ${expectedRobux} RBX sudah dibuat dan aktif.`;
      } else {
        errorMessage += ` Belum ada GamePass di game ini. Silakan buat GamePass dengan harga ${expectedRobux} RBX terlebih dahulu.`;
      }
      toast.error(errorMessage, {
        position: "top-right",
        autoClose: 8000,
        hideProgressBar: false,
        closeOnClick: true,
        pauseOnHover: true,
        draggable: true,
      });
    }
  } catch (error) {
    console.error("Error checking gamepass:", error);
    toast.error(
      "Terjadi kesalahan saat memeriksa GamePass. Silakan coba lagi.",
      {
        position: "top-right",
        autoClose: 5000,
        hideProgressBar: false,
        closeOnClick: true,
        pauseOnHover: true,
        draggable: true,
      }
    );
  } finally {
    setIsCheckingGamepass(false);
  }
};
